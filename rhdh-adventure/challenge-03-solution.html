<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>🧞👨‍💻 Lock It Down Solution :: Red Hat Developer Hub Adventure</title>
    <link rel="canonical" href="https://blog.jromanmartin.io/rhdh-adventure/rhdh-adventure/index.html/rhdh-adventure/challenge-03-solution.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/RHDLogo.svg" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://blog.jromanmartin.io/rhdh-adventure/rhdh-adventure/index.html">Red Hat Developer Hub Adventure</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="rhdh-adventure" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="index.html">A DevEx Adventure</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="challenge-01.html">🚀 The Adventure Begins</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="challenge-01.html#helmchart">📦 Helm Chart</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="challenge-01.html#operator">👷 Operator</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="challenge-02.html">🎨 Make It Your Own</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="challenge-02.html#configuration">🛠️ External configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="challenge-02.html#title">©️ Title it!</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="challenge-02.html#colors">🌈 Looking better</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="challenge-03.html">👨‍💻 Lock It Down</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="challenge-03.html#github-auth">🔑 Authentication with GitHub</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="challenge-03.html#gitlab-auth">🔑 Authentication with GitLab</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="challenge-03.html#rbac">🛂 You won&#8217;t break it</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="challenge-04.html">🕵🏻‍♂️ Import An Existing App</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="challenge-04.html#declare">📝 Declare it</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="challenge-04.html#import">📂 Import it</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="challenge-05.html">🧾 Streamline Future App Dev</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="challenge-05.html#softwaretemplate">💀 Software Template</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="challenge-05.html#onboard">🛬 Onboarding</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="challenge-06.html">🔌 Unlock New Capabilities</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="challenge-06.html#dynamicplugins">🦄 Dynamic Plugins</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="challenge-07.html">🔬 Put It Under The Microscope</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="challenge-07.html#tools">🧰 Tools</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="challenge-07.html#metrics">👨‍🔬 Metrics</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Red Hat Developer Hub Adventure</a></li>
    <li><a href="challenge-03-solution.html">🧞👨‍💻 Lock It Down Solution</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/rmarting/rhdh-adventure/edit/master/documentation/modules/ROOT/pages/challenge-03-solution.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">🧞👨‍💻 Lock It Down Solution</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Welcome! Don&#8217;t worry about being here—it&#8217;s absolutely okay! This section provides an example solution
to the challenge, offering a step-by-step implementation as a reference to guide you.</p>
</div>
<div class="paragraph">
<p>Remember, this is just one way to solve the challenge, and your approach might differ depending on
your creativity or specific requirements. Feel free to explore and adapt the solution to make it your own.
The goal is to help you understand the process and give you the confidence to tackle similar challenges
in the future. Let' 's dive in together! 🧞🚀</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="github-auth-solution"><a class="anchor" href="#github-auth-solution"></a>🧞🔑 Authentication with GitHub Solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Enabling GitHub authentication requires to create a GitHub application. This process  is described
<a href="https://docs.redhat.com/en/documentation/red_hat_developer_hub/1.4/html/authentication/authenticating-with-github#enabling-authentication-with-github">here</a></p>
</div>
<div class="paragraph">
<p>To enable discovery, then you need to use a GitHub organization</p>
</div>
<div class="paragraph">
<p>The following steps will depend of the mechanism used to operate Red Hat Developer Hub:</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset1_by-helm-chart"></a>By Helm Chart</p>
</li>
<li>
<p><a id="tabset1_by-operator"></a>By Operator</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset1_by-helm-chart">
<div class="ulist">
<ul>
<li>
<p><strong>GitHub App name</strong>: <code>rhdh-adventure</code></p>
</li>
<li>
<p><strong>Homepage URL</strong>: Copy output of</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>echo https://$(oc get route rhdh-developer-hub -o jsonpath='{.spec.host}')</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Authorization Callback URL</strong>: Copy output of</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>echo https://rhdh-developer-hub-$(oc project -q).${basedomain}/api/auth/github/handler/frame</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Webhook URL</strong>: Copy output of</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>echo https://$(oc get route rhdh-developer-hub -o jsonpath='{.spec.host}')</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Webhook secret</strong>: <code>this is my rhdh adventure</code></p>
</li>
<li>
<p><strong>Permissions</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Repository permissions</strong>: Enable <code>Read-only</code> access to: <code>Administration</code>, <code>Commit statutes</code>, <code>Contents</code>,
<code>Dependabot alerts</code>, <code>Deployments</code>, <code>Pull Requests</code>, <code>Webhooks</code>.</p>
</li>
<li>
<p><strong>Organization permissions</strong>: Enable <code>Read-Only</code> to <code>members</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Use <code>Read and Write</code> permissions to enable operations from Red Hat Developer Hub into GitHub.
</td>
</tr>
</table>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_by-operator">
<div class="ulist">
<ul>
<li>
<p><strong>GitHub App name</strong>: <code>rhdh-adventure</code></p>
</li>
<li>
<p><strong>Homepage URL</strong>: Copy output of</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>echo https://$(oc get route backstage-rhdh -o jsonpath='{.spec.host}')</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Authorization Callback URL</strong>: Copy output of</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>echo https://backstage-rhdh-$(oc project -q).${basedomain}/api/auth/github/handler/frame</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Webhook URL</strong>: Copy output of</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>echo https://$(oc get route backstage-rhdh -o jsonpath='{.spec.host}')</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Webhook secret</strong>: <code>this is my rhdh adventure</code></p>
</li>
<li>
<p><strong>Permissions</strong>:</p>
<div class="ulist">
<ul>
<li>
<p><strong>Repository permissions</strong>: Enable <code>Read-only</code> access to: <code>Administration</code>, <code>Commit statutes</code>, <code>Contents</code>,
<code>Dependabot alerts</code>, <code>Deployments</code>, <code>Pull Requests</code>, <code>Webhooks</code>.</p>
</li>
<li>
<p><strong>Organization permissions</strong>: Enable <code>Read-Only</code> to <code>members</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Use <code>Read and Write</code> permissions to enable operations from Red Hat Developer Hub into GitHub.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The name used for the Red Hat Developer Hub instance is <code>rhdh</code>. If you choose a different name,
please replace that pattern in the command with the name of your instance.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The private key can be generated from the settings page of the new GitHub application.
The <code>generate a private key</code> button will generate and download one.</p>
</div>
<div class="paragraph">
<p>After the new GitHub application was created, must be installed in the current account. Just
follow the instructions from the <code>Install App</code> menu.</p>
</div>
<div class="paragraph">
<p>Using the values from the new application create a secret to store the different values as:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">---
kind: Secret
apiVersion: v1
metadata:
  name: git-secrets
stringData:
  AUTH_GITHUB_APP_ID: REPLACE_WITH_YOUR_GITHUB_APP_ID
  AUTH_GITHUB_CLIENT_ID: REPLACE_WITH_YOUR_GITHUB_CLIENT_ID
  AUTH_GITHUB_CLIENT_SECRET: REPLACE_WITH_YOUR_GITHUB_CLIENT_SECRET
  AUTH_GITHUB_WEBHOOK_URL: REPLACE_WITH_YOUR_GITHUB_WEBHOOK_URL
  AUTH_GITHUB_WEBHOOK_SECRET: REPLACE_WITH_YOUR_GITHUB_WEBHOOK_SECRET
  AUTH_GITHUB_PRIVATE_KEY_FILE: |
    REPLACE_WITH_YOUR_GITHUB_PRIVATE_KEY_FILE
  GITHUB_ORGANIZATION: REPLACE_WITH_YOUR_GITHUB_ORGANIZATION
type: Opaque</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can apply your changes with this command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">oc apply -f ./documentation/modules/ROOT/examples/challenge-03/git-secrets-github.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Modify <code>rhdh-app-config</code> ConfigMap to add the authentication block (as the same level of the <code>app</code> block) as:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">    signInPage: github
    dangerouslyAllowSignInWithoutUserInCatalog: true
    auth:
      environment: development
      providers:
        github:
          development:
            clientId: ${AUTH_GITHUB_CLIENT_ID}
            clientSecret: ${AUTH_GITHUB_CLIENT_SECRET}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This sample configuration can help:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sed -e "s|\$rhdhname|$rhdhname|g" \
    -e "s|\$basedomain|$basedomain|g" \
    ./documentation/modules/ROOT/examples/challenge-03/rhdh-app-config-cm-github-01.yaml | oc apply -f -</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Notice that we set the <code>signInPage</code> to <code>github</code>, the default is <code>github</code>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
To disable guest login set the <code>environment</code> to <code>production</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Appling the configuration:</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset2_by-helm-chart"></a>By Helm Chart</p>
</li>
<li>
<p><a id="tabset2_by-operator"></a>By Operator</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset2_by-helm-chart">
<div class="paragraph">
<p>Update the <code>values.yaml</code> file to add the definition of the new secret:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">global:
  clusterRouterBase: "${basedomain}"
upstream:
  backstage:
    extraAppConfig:
      - configMapRef: rhdh-app-config
        filename: rhdh-app-config.yaml
    extraEnvVarsSecrets:
      - rhdh-secrets
      - git-secrets</code></pre>
</div>
</div>
<div class="paragraph">
<p>Rollout the changes into the Helm release:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">helm upgrade --install rhdh \
    openshift-helm-charts/redhat-developer-hub \
    -f ./documentation/modules/ROOT/examples/challenge-03/values-01.yaml \
    --set global.clusterRouterBase=$basedomain</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset2_by-operator">
<div class="paragraph">
<p>Update the Backstage definition to add the new secret:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spec:
  application:
    ...
    extraEnvs:
      secrets:
        - name: rhdh-secrets
        - name: git-secrets</code></pre>
</div>
</div>
<div class="paragraph">
<p>This sample configuration can be applied by:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f ./documentation/modules/ROOT/examples/challenge-03/rhdh-instance-01.yaml</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The name used for the Red Hat Developer Hub instance is <code>rhdh</code>. If you choose a different name,
please replace that pattern in the command with the name of your instance.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Verify that you can log in with a GitHub user.</p>
</div>
<div class="sect2">
<h3 id="_enable_github_plugin_integration"><a class="anchor" href="#_enable_github_plugin_integration"></a>Enable GitHub plugin integration</h3>
<div class="paragraph">
<p>To authenticate users, Red Hat Developer Hub requires their presence in the software catalog.
Consider configuring Red Hat Developer Hub to autodiscovery and provisioning users from GitHub
to the software catalog on schedule, rather than provisioning the users manually.</p>
</div>
<div class="paragraph">
<p>The Red Hat Developer Hub catalog can be set up to ingest organizational data (users and groups)
directly from GitHub. The result is a hierarchy of User and Group entities that mirrors your org setup.</p>
</div>
<div class="paragraph">
<p>This feature will crawl the GitHub instance and register entities matching the configured paths.
This can be useful as an alternative to static locations or manually adding things to the catalog.</p>
</div>
<div class="paragraph">
<p>Add the following integration configuration to the <code>app-config-rhdh</code> ConfigMap:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">    integrations:
      github:
        - host: github.com
          apps:
            - appId: ${AUTH_GITHUB_APP_ID}
              clientId: ${AUTH_GITHUB_CLIENT_ID}
              clientSecret: ${AUTH_GITHUB_CLIENT_SECRET}
              webhookUrl: ${AUTH_GITHUB_WEBHOOK_URL}
              webhookSecret: ${AUTH_GITHUB_WEBHOOK_SECRET}
              privateKey: |
                ${AUTH_GITHUB_PRIVATE_KEY_FILE}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Enabling member and repository discovery add the catalog definition to the <code>app-config-rhdh</code> ConfigMap:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">dangerouslyAllowSignInWithoutUserInCatalog: false
catalog:
  providers:
    github:
      providerId:
        organization: "${GITHUB_ORGANIZATION}"
        schedule:
          frequency:
            minutes: 30
          initialDelay:
            seconds: 15
          timeout:
            minutes: 15
    githubOrg:
      githubUrl: "https://github.com"
      orgs: [ "${GITHUB_ORGANIZATION}" ]
      schedule:
        frequency:
          minutes: 30
        initialDelay:
          seconds: 15
        timeout:
          minutes: 15</code></pre>
</div>
</div>
<div class="paragraph">
<p>To discover users and groups, it is needed to identify the GitHub organization.
The <code>GITHUB_ORGANIZATION</code> variable can be declared in the <code>git-secrets</code>, as the rest of
GitHub configuration variables.</p>
</div>
<div class="paragraph">
<p>This example will apply the full configuration described above:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sed -e "s|\$rhdhname|$rhdhname|g" \
    -e "s|\$basedomain|$basedomain|g" \
    ./documentation/modules/ROOT/examples/challenge-03/rhdh-app-config-cm-github-02.yaml | oc apply -f -</code></pre>
</div>
</div>
<div class="paragraph">
<p>The discovery capabilities are provided by a set of dynamic plugins that we need to enable.
The list of dynamic plugins to enable for this fully integration with GitHub is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>backstage-plugin-catalog-backend-module-github-dynamic</code></p>
</li>
<li>
<p><code>backstage-plugin-catalog-backend-module-github-org-dynamic</code></p>
</li>
<li>
<p><code>backstage-plugin-scaffolder-backend-module-github-dynamic</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>More information about Dynamic Plugins <a href="https://docs.redhat.com/en/documentation/red_hat_developer_hub/1.4/html-single/introduction_to_plugins/index">here</a>.</p>
</div>
<div class="paragraph">
<p>The following steps will depend of the mechanism used to operate Red Hat Developer Hub:</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset3_by-helm-chart"></a>By Helm Chart</p>
</li>
<li>
<p><a id="tabset3_by-operator"></a>By Operator</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset3_by-helm-chart">
<div class="paragraph">
<p>The definition of the dynamic plugins is done in the <code>values.yaml</code> file in the <code>dynamic.plugins</code> list:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">global:
  # Other configurations
  dynamic:
    includes:
      - dynamic-plugins.default.yaml
    plugins:
      - package: ./dynamic-plugins/dist/backstage-plugin-catalog-backend-module-github-dynamic
        disabled: false
      - package: ./dynamic-plugins/dist/backstage-plugin-catalog-backend-module-github-org-dynamic
        disabled: false
      - package: ./dynamic-plugins/dist/backstage-plugin-scaffolder-backend-module-github-dynamic
        disabled: false</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, we must apply the changes and upgrade the Helm release:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">helm upgrade --install rhdh \
    openshift-helm-charts/redhat-developer-hub \
    -f ./documentation/modules/ROOT/examples/challenge-03/values-02-github.yaml \
    --set global.clusterRouterBase=$basedomain</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset3_by-operator">
<div class="paragraph">
<p>To facilitate the management of the different dynamic plugins, we create the <code>rhdh-dynamic-plugins</code> ConfigMap:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">---
kind: ConfigMap
apiVersion: v1
metadata:
  name: rhdh-dynamic-plugins
data:
  dynamic-plugins.yaml: |
    includes:
      - dynamic-plugins.default.yaml
    plugins:
      - package: ./dynamic-plugins/dist/backstage-plugin-catalog-backend-module-github-dynamic
        disabled: false
      - package: ./dynamic-plugins/dist/backstage-plugin-catalog-backend-module-github-org-dynamic
        disabled: false
      - package: ./dynamic-plugins/dist/backstage-plugin-scaffolder-backend-module-github-dynamic
        disabled: false</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command will apply this sample configuration:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f ./documentation/modules/ROOT/examples/challenge-03/rhdh-dynamic-plugins-cm-github-01.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Update the Red Hat Developer Hub manifest to use the new ConfigMap for plugins:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spec:
  application:
    # Other configurations
    dynamicPluginsConfigMapName: rhdh-dynamic-plugins</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command will apply the changes:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f ./documentation/modules/ROOT/examples/challenge-03/rhdh-instance-02.yaml</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The name used for the Red Hat Developer Hub instance is <code>rhdh</code>. If you choose a different name,
please replace that pattern in the command with the name of your instance.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Red Hat Developer Hub is fully integrated with GitHub for authentication and discovery.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="gitlab-auth-solution"><a class="anchor" href="#gitlab-auth-solution"></a>🧞🔑 Authentication with GitLab Solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Enabling GitLab authentication requires to create a GitLab application within our GitLab instance. This
process is described <a href="https://backstage.io/docs/auth/gitlab/provider">here</a>, however, keep in mind to
execute the actions in your GitLab instance:</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset4_by-helm-chart"></a>By Helm Chart</p>
</li>
<li>
<p><a id="tabset4_by-operator"></a>By Operator</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset4_by-helm-chart">
<div class="ulist">
<ul>
<li>
<p>GitLab UI navigation: Edit <code>Profile</code> &#8594; <code>Applications</code> &#8594; <code>Add new application</code></p>
</li>
<li>
<p>name: <code>rhdh-adventure</code></p>
</li>
<li>
<p>Redirect URI: Copy output of</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>echo https://rhdh-developer-hub-$(oc project -q).${basedomain}/api/auth/gitlab/handler/frame</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Set the correct permissions: <code>api</code>, <code>read_user</code>, <code>read_repository</code>, <code>write_repository</code>, <code>openid</code>, <code>profile</code>, <code>email</code></p>
</li>
</ul>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset4_by-operator">
<div class="ulist">
<ul>
<li>
<p>GitLab UI navigation: Edit <code>Profile</code> &#8594; <code>Applications</code> &#8594; <code>Add new application</code></p>
</li>
<li>
<p>name: <code>rhdh-adventure</code></p>
</li>
<li>
<p>Redirect URI: copy output <code>echo <a href="https://backstage-rhdh-$(oc" class="bare">https://backstage-rhdh-$(oc</a> project -q).${basedomain}/api/auth/gitlab/handler/frame</code></p>
</li>
<li>
<p>set the correct permissions: <code>api</code>, <code>read_user</code>, <code>read_repository</code>, <code>write_repository</code>, <code>openid</code>, <code>profile</code>, <code>email</code></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The name used for the Red Hat Developer Hub instance is <code>rhdh</code>. If you choose a different name,
please replace that pattern in the command with the name of your instance.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Additionally, we need to create a Personal Access Token (aka PAT) to enable the full integration with GitLab.
Create a PAT of GitLab user profile as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>GitLab UI navigation: Edit Profile &#8594; Access Tokens &#8594; Add new token</p>
</li>
<li>
<p>name: <code>pat-rhdh-adventure</code></p>
</li>
<li>
<p>expiration date: Disabled it or just one in the future</p>
</li>
<li>
<p>set the scopes: <code>api</code>, <code>read_api</code>, <code>read_repository</code>, <code>write_repository</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>From the new application and PAT create a secret to store the application id, secret id and token as:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">---
kind: Secret
apiVersion: v1
metadata:
  name: git-secrets
stringData:
  AUTH_GITLAB_CLIENT_ID: REPLACE_WITH_YOUR_GITLAB_CLIENT_ID
  AUTH_GITLAB_CLIENT_SECRET: REPLACE_WITH_YOUR_GITLAB_CLIENT_SECRET
  AUTH_GITLAB_TOKEN: REPLACE_WITH_YOUR_GITLAB_PAT
type: Opaque</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can apply your changes with this command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f ./documentation/modules/ROOT/examples/challenge-03/git-secrets-gitlab.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Modify <code>rhdh-app-config</code> ConfigMap to add the authentication block (as the same level of the <code>app</code> block) as:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">    signInPage: gitlab
    dangerouslyAllowSignInWithoutUserInCatalog: true
    auth:
      environment: production
      providers:
        gitlab:
          production:
            clientId: ${AUTH_GITLAB_CLIENT_ID}
            clientSecret: ${AUTH_GITLAB_CLIENT_SECRET}
            audience: <a href="https://gitlab.${basedomain}" class="bare">https://gitlab.${basedomain}</a></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Notice that we set the <code>signInPage</code> to <code>gitlab</code>, the default is <code>github</code>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
To disable guest login set the <code>environment</code> to <code>production</code>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If you are using the public GitLab instance, don&#8217;t add the <code>audience</code> property.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This sample configuration can help:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sed -e "s|\$rhdhname|$rhdhname|g" \
    -e "s|\$basedomain|$basedomain|g" \
    ./documentation/modules/ROOT/examples/challenge-03/rhdh-app-config-cm-gitlab-01.yaml | oc apply -f -</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Notice that we set the <code>signInPage</code> to <code>gitlab</code>, the default is <code>github</code>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
To disable guest login set the <code>environment</code> to <code>production</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Appling the configuration:</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset5_by-helm-chart"></a>By Helm Chart</p>
</li>
<li>
<p><a id="tabset5_by-operator"></a>By Operator</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset5_by-helm-chart">
<div class="paragraph">
<p>Update the <code>values.yaml</code> file to add the definition of the new secret:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">global:
  clusterRouterBase: "${basedomain}"
upstream:
  backstage:
    extraAppConfig:
      - configMapRef: rhdh-app-config
        filename: rhdh-app-config.yaml
    extraEnvVarsSecrets:
      - rhdh-secrets
      - git-secrets</code></pre>
</div>
</div>
<div class="paragraph">
<p>Rollout the changes into the Helm release:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">helm upgrade --install rhdh \
    openshift-helm-charts/redhat-developer-hub \
    -f ./documentation/modules/ROOT/examples/challenge-03/values-01.yaml \
    --set global.clusterRouterBase=$basedomain</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset5_by-operator">
<div class="paragraph">
<p>Update the Backstage definition to add the new secret:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spec:
  application:
    ...
    extraEnvs:
      secrets:
        - name: rhdh-secrets
        - name: git-secrets</code></pre>
</div>
</div>
<div class="paragraph">
<p>This sample configuration can be applied by:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f ./documentation/modules/ROOT/examples/challenge-03/rhdh-instance-01.yaml</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The name used for the Red Hat Developer Hub instance is <code>rhdh</code>. If you choose a different name,
please replace that pattern in the command with the name of your instance.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Verify that you can login with GitLab.</p>
</div>
<div class="sect2">
<h3 id="_enable_gitlab_plugin_integration"><a class="anchor" href="#_enable_gitlab_plugin_integration"></a>Enable GitLab plugin integration</h3>
<div class="paragraph">
<p>The GitLab integration has a special entity provider for discovering catalog entities from GitLab. The entity provider
will crawl the GitLab instance and register entities matching the configured paths. This can be useful as an alternative
to static locations or manually adding things to the catalog.</p>
</div>
<div class="paragraph">
<p>Add the following integration configuration to the <code>app-config-rhdh</code> ConfigMap:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">    integrations:
      gitlab:
        - host: gitlab.${basedomain}
          token: ${GITLAB_TOKEN}
          apiBaseUrl: <a href="https://gitlab.${basedomain}/api/v4" class="bare">https://gitlab.${basedomain}/api/v4</a>
          baseUrl: <a href="https://gitlab.${basedomain}" class="bare">https://gitlab.${basedomain}</a> # or your gitlab instance url</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once we have integrated GitLab with Red Hat Developer Hub, we need to enable the autodiscovery
capabilities of this provider. Very useful to load our catalog with repositories already created in
our GitLab server.</p>
</div>
<div class="paragraph">
<p>Add the catalog definition to the <code>app-config-rhdh</code> ConfigMap:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">    # Catalog
    catalog:
      providers:
        gitlab:
          myGitLab:
            host: gitlab.${basedomain} # Identifies one of the hosts set up in the integrations
            apiBaseUrl: <a href="https://gitlab.${basedomain}/api/v4" class="bare">https://gitlab.${basedomain}/api/v4</a>
            branch: main # Optional. Used to discover on a specific branch
            fallbackBranch: master # Optional. Fallback to be used if there is no default branch configured at the Gitlab repository. It is only used, if `branch` is undefined. Uses `master` as default
            skipForkedRepos: false # Optional. If the project is a fork, skip repository
            entityFilename: catalog-info.yaml # Optional. Defaults to `catalog-info.yaml`
            projectPattern: '[\s\S]*' # Optional. Filters found projects based on provided patter. Defaults to `[\s\S]*`, which means to not filter anything
            schedule: # optional; same options as in TaskScheduleDefinition
              # supports cron, ISO duration, "human duration" as used in code
              frequency: { minutes: 30 }
              # supports ISO duration, "human duration" as used in code
              timeout: { minutes: 15 }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Red Hat Developer Hub catalog can be set up to ingest organizational data&#8201;&#8212;&#8201;users and groups&#8201;&#8212;&#8201;directly from GitLab.
The result is a hierarchy of User and Group entities that mirrors your org setup.</p>
</div>
<div class="paragraph">
<p>Once we have integrated GitLab with Red Hat Developer Hub, we need to enable the autodiscovery
capabilities of users and groups. That requires to enable the <code>backstage-plugin-catalog-backend-module-gitlab-org-dynamic</code>
dynamic plugin provided by Red Hat Developer Hub.</p>
</div>
<div class="paragraph">
<p>Add this to the ConfigMap:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">    catalog:
      providers:
        gitlab:
          myGitLab:
          host: gitlab.${basedomain}
            # ... previous GitLab configuration
            orgEnabled: true
            #group: org/teams # Required for gitlab.com when `orgEnabled: true`. Optional for self managed. Must not end with slash. Accepts only groups under the provided path (which will be stripped)
            allowInherited: true # Allow groups to be ingested even if there are no direct members.
            groupPattern: '[\s\S]*'
            restrictUsersToGroup: false</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example will apply the full configuration described above:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sed -e "s|\$rhdhname|$rhdhname|g" \
    -e "s|\$basedomain|$basedomain|g" \
    ./documentation/modules/ROOT/examples/challenge-03/rhdh-app-config-cm-gitlab-02.yaml | oc apply -f -</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, we need to enable some extra dynamic plugins to setup finally the integration with GitLab:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>backstage-plugin-catalog-backend-module-gitlab-dynamic</p>
</li>
<li>
<p>backstage-plugin-catalog-backend-module-gitlab-org-dynamic</p>
</li>
<li>
<p>backstage-plugin-scaffolder-backend-module-gitlab-dynamic</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>More information about Dynamic Plugins <a href="https://docs.redhat.com/en/documentation/red_hat_developer_hub/1.4/html-single/introduction_to_plugins/index">here</a>.</p>
</div>
<div class="paragraph">
<p>The following steps will depend of the mechanism used to operate Red Hat Developer Hub:</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset6_by-helm-chart"></a>By Helm Chart</p>
</li>
<li>
<p><a id="tabset6_by-operator"></a>By Operator</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset6_by-helm-chart">
<div class="paragraph">
<p>The definition of the dynamic plugins is done in the <code>values.yaml</code> file in the
<code>dynamic.plugins</code> list:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">global:
  # Other configurations
  dynamic:
    includes:
      - dynamic-plugins.default.yaml
    plugins:
      # GitLab Plugins
      - package: ./dynamic-plugins/dist/backstage-plugin-catalog-backend-module-gitlab-dynamic
        disabled: false
      - package: ./dynamic-plugins/dist/backstage-plugin-catalog-backend-module-gitlab-org-dynamic
        disabled: false
      - package: ./dynamic-plugins/dist/backstage-plugin-scaffolder-backend-module-gitlab-dynamic
        disabled: false</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, we must apply the changes and upgrade the Helm release:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">helm upgrade --install rhdh \
    openshift-helm-charts/redhat-developer-hub \
    -f ./documentation/modules/ROOT/examples/challenge-03/values-02-gitlab.yaml \
    --set global.clusterRouterBase=$basedomain</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset6_by-operator">
<div class="paragraph">
<p>To facilitate the management of the different dynamic plugins, we create the <code>rhdh-dynamic-plugins</code> ConfigMap:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">---
kind: ConfigMap
apiVersion: v1
metadata:
  name: rhdh-dynamic-plugins
data:
  dynamic-plugins.yaml: |
    includes:
      - dynamic-plugins.default.yaml
    plugins:
      - package: ./dynamic-plugins/dist/backstage-plugin-catalog-backend-module-gitlab-dynamic
        disabled: false
      - package: ./dynamic-plugins/dist/backstage-plugin-catalog-backend-module-gitlab-org-dynamic
        disabled: false
      - package: ./dynamic-plugins/dist/backstage-plugin-scaffolder-backend-module-gitlab-dynamic
        disabled: false</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command will apply this sample configuration:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f ./documentation/modules/ROOT/examples/challenge-03/rhdh-dynamic-plugins-cm-gitlab-01.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Update the Red Hat Developer Hub manifest to use the new ConfigMap for plugins:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spec:
  application:
    # Other configurations
    dynamicPluginsConfigMapName: rhdh-dynamic-plugins</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command will apply the changes:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f ./documentation/modules/ROOT/examples/challenge-03/rhdh-instance-02.yaml</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The name used for the Red Hat Developer Hub instance is <code>rhdh</code>. If you choose a different name,
please replace that pattern in the command with the name of your instance.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Red Hat Developer Hub is fully integrated with GitLab for authentication and discovery.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="rbac-solution"><a class="anchor" href="#rbac-solution"></a>🧞🛂 You won&#8217;t break it Solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>After authentication is working, we can enable authorization policies using the RBAC capabilities of Red Hat Developer Hub.
The process is easy by adding some extra configuration and describing the RBAC rules per user or group.</p>
</div>
<div class="paragraph">
<p>Create a new <code>rbac-policies.csv</code> file in a new ConfigMap to declare the authorization policies:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># Catalog permissions
p, role:default/administrators, catalog-entity, read, allow
p, role:default/administrators, catalog.entity.read, read, allow
p, role:default/administrators, catalog.entity.create, create, allow
p, role:default/administrators, catalog.entity.refresh, update, allow
p, role:default/administrators, catalog.entity.delete, delete, allow
p, role:default/administrators, catalog.location.read, read, allow
p, role:default/administrators, catalog.location.create, create, allow
p, role:default/administrators, catalog.location.delete, delete, allow
# Scaffolder permissions
p, role:default/administrators, scaffolder-action, use, allow
p, role:default/administrators, scaffolder.action.execute, use, allow
p, role:default/administrators, scaffolder-template, read, allow
p, role:default/administrators, scaffolder.template.parameter.read, read, allow
p, role:default/administrators, scaffolder.template.step.read, read, allow
p, role:default/administrators, scaffolder.task.create, create, allow
p, role:default/administrators, scaffolder.task.cancel, use, allow
p, role:default/administrators, scaffolder.task.read, read, allow
# RBAC permissions
p, role:default/administrators, policy.entity.read, read, allow
p, role:default/administrators, policy.entity.create, create, allow
p, role:default/administrators, policy.entity.update, update, allow
p, role:default/administrators, policy.entity.delete, delete, allow
# Kubernetes permissions
#p, role:default/administrators, kubernetes.proxy, use, allow
# OCM permissions
#p, role:default/administrators, ocm.entity.read, read, allow
#p, role:default/administrators, ocm.cluster.read, read, allow
# Topology permissions
#p, role:default/administrators, topology.view.read, read, allow

# My Own Admin User
g, user:default/adminID, role:default/administrators
g, user:default/rmarting, role:default/administrators

# Team-A Role
# Catalog permissions
p, role:default/team-a, catalog.entity.read, read, allow
p, role:default/team-a, catalog.entity.create, create, allow
p, role:default/team-a, catalog.entity.refresh, update, allow
p, role:default/team-a, catalog.entity.delete, delete, allow
p, role:default/team-a, catalog.location.read, read, allow
p, role:default/team-a, catalog.location.create, create, allow
p, role:default/team-a, catalog.location.delete, delete, allow
# Scaffolder permissions
p, role:default/team-a, scaffolder.action.execute, use, allow
p, role:default/team-a, scaffolder.template.parameter.read, read, allow
p, role:default/team-a, scaffolder.template.step.read, read, allow
p, role:default/team-a, scaffolder.task.create, create, allow
p, role:default/team-a, scaffolder.task.cancel, use, allow
p, role:default/team-a, scaffolder.task.read, read, allow
# Kubernetes permissions
#p, role:default/team-a, kubernetes.proxy, use, allow
# OCM permissions
#p, role:default/team-a, ocm.entity.read, read, allow
#p, role:default/team-a, ocm.cluster.read, read, allow
# Topology permissions
#p, role:default/team-a, topology.view.read, read, allow

# Team-B Role
p, role:default/team-b, catalog.entity.read, read, deny

# Groups
g, group:default/team-a, role:default/team-a
g, group:default/team-b, role:default/team-b

# Users
#g, user:default/&lt;user-team-a&gt;, role:default/team-a
#g, user:default/&lt;user-team-b&gt;, role:default/team-b</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command will create the example:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc create configmap rbac-policies --from-file=./documentation/modules/ROOT/examples/challenge-03/rbac-policies.csv</code></pre>
</div>
</div>
<div class="paragraph">
<p>Declare the policies file as part of the configuration inside the <code>app-config-rhdh</code> ConfigMap:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">    # RBAC
    permission:
      enabled: true
      rbac:
        admin:
          users:
            - name: user:default/adminID
        policies-csv-file: /opt/app-root/src/rbac/rbac-policies.csv
        pluginsWithPermission:
          - catalog
          - scaffolder
          - permission</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Declare one user of your organization as the default administrator. Replace <code>adminID</code> with a valid value.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Apply the configuration for the right Git server:</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset7_github"></a>GitHub</p>
</li>
<li>
<p><a id="tabset7_gitlab"></a>GitLab</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset7_github">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sed -e "s|\$rhdhname|$rhdhname|g" \
    -e "s|\$basedomain|$basedomain|g" \
    ./documentation/modules/ROOT/examples/challenge-03/rhdh-app-config-cm-github-03.yaml | oc apply -f -</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset7_gitlab">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sed -e "s|\$rhdhname|$rhdhname|g" \
    -e "s|\$basedomain|$basedomain|g" \
    ./documentation/modules/ROOT/examples/challenge-03/rhdh-app-config-cm-gitlab-03.yaml | oc apply -f -</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>That configuration is used by the <code>backstage-community-plugin-rba</code> plugin included in Red Hat Developer Hub and
it must to enable it.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">      - package: './dynamic-plugins/dist/backstage-community-plugin-rbac'
        disabled: false</code></pre>
</div>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset8_by-helm-chart"></a>By Helm Chart</p>
</li>
<li>
<p><a id="tabset8_by-operator"></a>By Operator</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset8_by-helm-chart">
<div class="paragraph">
<p>This configuration must be done in the <code>values.yaml</code> file similar to:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">global:
  # Other configurations
  dynamic:
    includes:
      - dynamic-plugins.default.yaml
    plugins:
      # Other Plugins
      # RBAC Plugins
      - package: './dynamic-plugins/dist/backstage-community-plugin-rbac'
        disabled: false</code></pre>
</div>
</div>
<div class="paragraph">
<p>Mount the policies file in the Helm Chart configuration as another extra configuration in the <code>values.yaml</code> file:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">upstream:
  backstage:
    # Other Configuration
    extraVolumeMounts:
      - mountPath: /opt/app-root/src/dynamic-plugins-root
        name: dynamic-plugins-root
      - mountPath: /opt/app-root/src/rbac # Mounting point for RBAC policies
        name: rbac-policies
    extraVolumes:
      # Other volumes created by the Helm Chart
      - configMap:
          defaultMode: 420
          name: rbac-policies
        name: rbac-policies</code></pre>
</div>
</div>
<div class="paragraph">
<p>To apply this configuration for GitHub use this command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">helm upgrade --install rhdh \
    openshift-helm-charts/redhat-developer-hub \
    -f ./documentation/modules/ROOT/examples/challenge-03/values-03-github.yaml \
    --set global.clusterRouterBase=$basedomain</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the case of GitLab use this command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">helm upgrade --install rhdh \
    openshift-helm-charts/redhat-developer-hub \
    -f ./documentation/modules/ROOT/examples/challenge-03/values-03-gitlab.yaml \
    --set global.clusterRouterBase=$basedomain</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset8_by-operator">
<div class="paragraph">
<p>Update the <code>rhdh-dynamic-plugins</code> ConfigMap to add the definition of the new plugin:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">---
kind: ConfigMap
apiVersion: v1
metadata:
  name: rhdh-dynamic-plugins
data:
  dynamic-plugins.yaml: |
    includes:
      - dynamic-plugins.default.yaml
    plugins:
      # Other Plugins
      - package: './dynamic-plugins/dist/backstage-community-plugin-rbac'
        disabled: false</code></pre>
</div>
</div>
<div class="paragraph">
<p>Apply the new list of dynamic plugins:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f ./documentation/modules/ROOT/examples/challenge-03/rhdh-dynamic-plugins-cm-github-02.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Mount the policies file in the <code>Backstage</code> manifests as:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">  application:
    appConfig:
      mountPath: /opt/app-root/src
      configMaps:
        - name: rhdh-app-config
    extraFiles:
      mountPath: /opt/app-root/src/rbac
      configMaps:
        - name: rbac-policies
          key: rbac-policies.csv</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command will update the Backstage definition:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f ./documentation/modules/ROOT/examples/challenge-03/rhdh-instance-03.yaml</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The name used for the Red Hat Developer Hub instance is <code>rhdh</code>. If you choose a different name,
please replace that pattern in the command with the name of your instance.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Logout and login again using the declared policy administrator account. If RBAC is enabled, the
administrator will have the <code>RBAC</code> option inside the <code>Administration</code> menu:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/challenge-03/rhdh-rbac.png" alt="RBAC management from UI">
</div>
</div>
<div class="paragraph">
<p>This menu allows to manage the RBAC rules directly in the UI.</p>
</div>
<div class="paragraph">
<p>Login with different users to verify the rules applied per user or group.</p>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
